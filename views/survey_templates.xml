<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Standalone template for match following question type -->
    <template id="match_following_question_template" name="Survey Match Following Question">
        <div class="match_following_container js_question-wrapper" t-att-data-question-id="question.id">
            <div class="row">
                <div class="col-md-6">
                    <h5>Items</h5>
                    <div class="o_match_questions">
                        <t t-foreach="question.match_following_pairs" t-as="pair">
                            <div class="o_match_item" t-att-data-pair-id="pair.id">
                                <span t-field="pair.left_option"/>
                            </div>
                        </t>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Matches</h5>
                    <div class="o_match_answers">
                        <t t-foreach="question.match_following_pairs" t-as="pair">
                            <div class="o_match_item" t-att-data-pair-id="pair.id">
                                <span t-field="pair.right_option"/>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            <input type="hidden" t-att-name="'question_%s' % question.id" t-att-value="user_input_line.value_match_following if user_input_line else None"/>
        </div>
    </template>
    
    <!-- In Odoo 17, we need to find the correct templates to extend -->
    <!-- Just use survey.layout instead since it should always exist -->
    <template id="survey_layout_inject" inherit_id="survey.layout">
        <xpath expr="//head" position="inside">
            <!-- Add match following support script -->
            <script type="text/javascript">
                $(document).ready(function() {
                    // Wait for page to load, then check if we need to handle match following
                    setTimeout(function() {
                        // Scan for questions of type match_following
                        var $questions = $('.o_survey_form .js_question-wrapper');
                        $questions.each(function() {
                            var $question = $(this);
                            var questionType = $question.data('questionType');
                            if (questionType === 'match_following') {
                                // Create match following container if it doesn't exist
                                if (!$question.find('.match_following_container').length) {
                                    console.log('Initializing match following for question:', $question.data('questionId'));
                                    initMatchFollowing($question);
                                }
                            }
                        });
                    }, 500);
                    
                    function initMatchFollowing($question) {
                        // Get match following data
                        var questionId = $question.data('questionId');
                        var questionTitle = $question.find('.o_survey_question_text').text();
                        
                        console.log('Match following initialized for:', questionTitle, '(ID:', questionId, ')');
                        
                        // If we need to dynamically create the structure
                        if (window.customElearnMatchFollowing &amp;&amp; window.customElearnMatchFollowing.setup) {
                            window.customElearnMatchFollowing.setup();
                        }
                    }
                });
            </script>
            
            <!-- Add CSS for match following -->
            <style>
                .match_following_container {
                    margin: 20px 0;
                }
                
                .o_match_questions, .o_match_answers {
                    min-height: 100px;
                    border: 1px dashed #ccc;
                    padding: 10px;
                    margin-bottom: 15px;
                    border-radius: 4px;
                }
                
                .o_match_item {
                    background-color: #f8f9fa;
                    border: 1px solid #ddd;
                    padding: 8px 12px;
                    margin: 5px 0;
                    border-radius: 4px;
                    cursor: move;
                }
                
                .o_match_item.dragging {
                    opacity: 0.5;
                }
                
                .o_match_item.matched {
                    background-color: #d4edda;
                    border-color: #c3e6cb;
                }
                
                .drop-zone-active {
                    background-color: #f2f7ff;
                    border-color: #b8daff;
                }
            </style>
        </xpath>
    </template>
    
    <!-- Create a direct template that can be injected -->
    <template id="survey_question_match_following_container">
        <div t-if="question.question_type == 'match_following'" class="match_following_container" t-att-data-question-id="question.id">
            <div class="row">
                <div class="col-md-6">
                    <h5>Items</h5>
                    <div class="o_match_questions">
                        <t t-foreach="question.match_following_pairs" t-as="pair">
                            <div class="o_match_item" t-att-data-pair-id="pair.id">
                                <span t-field="pair.left_option"/>
                            </div>
                        </t>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Matches</h5>
                    <div class="o_match_answers">
                        <t t-foreach="question.match_following_pairs" t-as="pair">
                            <div class="o_match_item" t-att-data-pair-id="pair.id">
                                <span t-field="pair.right_option"/>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            <input type="hidden" t-att-name="'question_%s' % question.id" value="[]"/>
        </div>
    </template>
</odoo>
